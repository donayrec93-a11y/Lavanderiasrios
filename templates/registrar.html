{% extends "base.html" %}
{% block title %}Registro Simple ¬∑ Lavander√≠a R√çOS{% endblock %}
{% block content %}
<section class="card">
  <h2>üìù Registro Simple</h2>
  <p style="color: var(--muted); margin-bottom: 24px;">
    Completa los datos del servicio. El precio final lo calcular√° el sistema autom√°ticamente.
  </p>

  <form method="post" class="form-grid">
    <div class="form-group">
      <label for="cliente">Nombre del Cliente *</label>
      <input type="text" name="cliente" id="cliente" required value="{{ form.get('cliente','') }}" 
             placeholder="Nombre completo del cliente" />
    </div>

    <div class="form-group">
      <label for="tipo_item">Tipo de servicio *</label>
      <select name="tipo_item" id="tipo_item" required>
        <option value="kilos" {% if form.get('tipo_item','kilos')=='kilos' %}selected{% endif %}>
          Por kilos (S/ 3.50/kg)
        </option>
        <option value="edredon" {% if form.get('tipo_item')=='edredon' %}selected{% endif %}>
          Edred√≥n (S/ 15.00 c/u)
        </option>
        <option value="terno" {% if form.get('tipo_item')=='terno' %}selected{% endif %}>
          Terno (S/ 20.00 c/u)
        </option>
      </select>
    </div>

    <div class="form-group" id="wrap_kilos">
      <label for="kilos">Kilos de ropa</label>
      <input type="number" name="kilos" id="kilos" min="0" step="0.1" 
             value="{{ form.get('kilos','0') }}" placeholder="0.0" />
      <small style="color: var(--muted); font-size: 13px;">
        Solo para servicios por kilos
      </small>
    </div>

    <div class="form-group" id="wrap_cantidad">
      <label for="cantidad">Cantidad de piezas</label>
      <input type="number" name="cantidad" id="cantidad" min="0" step="1" 
             value="{{ form.get('cantidad','0') }}" placeholder="0" />
      <small style="color: var(--muted); font-size: 13px;">
        Para edredones y ternos
      </small>
    </div>

    <div class="form-group">
      <label for="servicio">Tipo de servicio</label>
      <select name="servicio" id="servicio">
        <option value="normal" {% if form.get('servicio','normal')=='normal' %}selected{% endif %}>
          Normal
        </option>
        <option value="seco" {% if form.get('servicio')=='seco' %}selected{% endif %}>
          Lavado en seco (+S/ 2.00)
        </option>
        <option value="mano" {% if form.get('servicio')=='mano' %}selected{% endif %}>
          Lavado a mano (+S/ 1.50)
        </option>
      </select>
    </div>

    <div class="form-group">
      <label for="metodo_pago">M√©todo de pago</label>
      <select name="metodo_pago" id="metodo_pago">
        <option value="efectivo" {% if form.get('metodo_pago','efectivo')=='efectivo' %}selected{% endif %}>
          üíµ Efectivo
        </option>
        <option value="yape" {% if form.get('metodo_pago')=='yape' %}selected{% endif %}>
          üì± Yape
        </option>
        <option value="plin" {% if form.get('metodo_pago')=='plin' %}selected{% endif %}>
          üì± Plin
        </option>
        <option value="tarjeta" {% if form.get('metodo_pago')=='tarjeta' %}selected{% endif %}>
          üí≥ Tarjeta
        </option>
      </select>
    </div>

    <!-- Perfumado con checkbox mejorado -->
    <div class="form-group full">
      <div class="checkbox-group">
        <label class="checkbox-custom">
          <input type="checkbox" name="perfumado" {% if form.get('perfumado') %}checked{% endif %} />
          <span class="checkmark"></span>
        </label>
        <span class="checkbox-label">üå∏ Agregar perfumado (+S/ 0.50)</span>
      </div>
      <small style="color: var(--muted); margin-left: 32px;">
        Deja tu ropa con un aroma fresco y agradable
      </small>
    </div>

    <!-- Vista previa del precio -->
    <div class="full" style="background: #f8fafc; padding: 20px; border-radius: 8px; margin: 16px 0;">
      <h4 style="margin: 0 0 12px; color: var(--primary);">üí∞ Precio Estimado</h4>
      <div id="precio-preview" style="font-size: 18px; font-weight: 600; color: var(--text);">
        S/ 0.00
      </div>
      <small style="color: var(--muted);">
        *El precio final se calcular√° autom√°ticamente al guardar
      </small>
    </div>

    <div style="grid-column: 1 / -1; display: flex; gap: 12px; justify-content: center; margin-top: 20px;">
      <button class="btn success" type="submit" style="min-width: 180px;">
        üíæ Guardar Boleta
      </button>
      <a class="btn secondary" href="{{ url_for('boletas') }}">
        üìã Ver Boletas
      </a>
      <a class="btn" href="{{ url_for('boleta_nueva') }}">
        ‚ûï Boleta Completa
      </a>
    </div>
  </form>
</section>

<script>
// Configuraci√≥n de precios
const PRECIOS = {
  kilos: 3.50,
  edredon: 15.00,
  terno: 20.00,
  perfumado: 0.50,
  seco: 2.00,
  mano: 1.50
};

function toggleFields() {
  const tipo = document.getElementById('tipo_item').value;
  const wrapKilos = document.getElementById('wrap_kilos');
  const wrapCantidad = document.getElementById('wrap_cantidad');
  const kilosInput = document.getElementById('kilos');
  const cantidadInput = document.getElementById('cantidad');
  
  if (tipo === 'kilos') {
    wrapKilos.style.display = 'block';
    wrapCantidad.style.display = 'none';
    kilosInput.required = true;
    cantidadInput.required = false;
    cantidadInput.value = '0';
  } else {
    wrapKilos.style.display = 'none';
    wrapCantidad.style.display = 'block';
    kilosInput.required = false;
    cantidadInput.required = true;
    kilosInput.value = '0';
  }
  calculatePrice();
}

function calculatePrice() {
  const tipo = document.getElementById('tipo_item').value;
  const kilos = parseFloat(document.getElementById('kilos').value || 0);
  const cantidad = parseInt(document.getElementById('cantidad').value || 0);
  const servicio = document.getElementById('servicio').value;
  const perfumado = document.querySelector('input[name="perfumado"]').checked;
  
  let precio = 0;
  
  // Precio base
  if (tipo === 'kilos' && kilos > 0) {
    precio = kilos * PRECIOS.kilos;
  } else if (tipo === 'edredon' && cantidad > 0) {
    precio = cantidad * PRECIOS.edredon;
  } else if (tipo === 'terno' && cantidad > 0) {
    precio = cantidad * PRECIOS.terno;
  }
  
  // Recargos por servicio
  if (servicio === 'seco') {
    if (tipo === 'kilos') {
      precio += kilos * PRECIOS.seco;
    } else {
      precio += cantidad * PRECIOS.seco;
    }
  } else if (servicio === 'mano') {
    if (tipo === 'kilos') {
      precio += kilos * PRECIOS.mano;
    } else {
      precio += cantidad * PRECIOS.mano;
    }
  }
  
  // Perfumado
  if (perfumado) {
    if (tipo === 'kilos') {
      precio += kilos * PRECIOS.perfumado;
    } else {
      precio += cantidad * PRECIOS.perfumado;
    }
  }
  
  // Mostrar precio
  document.getElementById('precio-preview').textContent = 'S/ ' + precio.toFixed(2);
}

// Event listeners
document.getElementById('tipo_item').addEventListener('change', toggleFields);
document.getElementById('kilos').addEventListener('input', calculatePrice);
document.getElementById('cantidad').addEventListener('input', calculatePrice);
document.getElementById('servicio').addEventListener('change', calculatePrice);
document.querySelector('input[name="perfumado"]').addEventListener('change', calculatePrice);

// Inicializar
toggleFields();
calculatePrice();

// Validaci√≥n del formulario
document.querySelector('form').addEventListener('submit', function(e) {
  const tipo = document.getElementById('tipo_item').value;
  const kilos = parseFloat(document.getElementById('kilos').value || 0);
  const cantidad = parseInt(document.getElementById('cantidad').value || 0);
  const cliente = document.getElementById('cliente').value.trim();
  
  if (!cliente) {
    alert('Por favor ingresa el nombre del cliente');
    e.preventDefault();
    return;
  }
  
  if (tipo === 'kilos' && kilos <= 0) {
    alert('Por favor ingresa los kilos (mayor a 0)');
    e.preventDefault();
    return;
  }
  
  if ((tipo === 'edredon' || tipo === 'terno') && cantidad <= 0) {
    alert('Por favor ingresa la cantidad (mayor a 0)');
    e.preventDefault();
    return;
  }
});
</script>

<style>
/* Estilos espec√≠ficos para el formulario de registro */
.form-group.full {
  grid-column: span 12;
}

@media (max-width: 768px) {
  .form-group {
    grid-column: span 12;
  }
}

/* Animaci√≥n suave para mostrar/ocultar campos */
#wrap_kilos, #wrap_cantidad {
  transition: all 0.3s ease;
}

/* Mejorar el checkbox de perfumado */
.checkbox-group {
  background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
  padding: 16px;
  border-radius: 8px;
  border: 1px solid #bbf7d0;
}

.checkbox-label {
  font-size: 16px;
  font-weight: 500;
}
</style>
{% endblock %}